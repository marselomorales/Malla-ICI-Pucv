<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light dark" />
  <title>Malla Interactiva — Ingeniería Civil en Informática</title>

  <!-- Iconos desde CDN -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  <!-- Fuentes de Google -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --font-main: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      --font-secondary: 'Inter', sans-serif;
      
      --bg-light: #f8fafc;
      --bg-dark: #0f172a;
      --card-light: #ffffff;
      --card-dark: #1e293b;
      --ink-light: #1e293b;
      --ink-dark: #e2e8f0;

      --accent: #4f46e5;
      --accent-2: #10b981;
      --accent-light: #e0e7ff;
      --accent-dark: #3730a3;

      --programacion: #4f46e5;
      --matematicas: #ef4444;
      --fisica: #10b981;
      --ingenieria: #f59e0b;
      --humanidades: #f97316;
      --optativos: #8b5cf6;
      --fofu: #0ea5e9;

      --tip-max-w: 420px;
      
      --border-radius: 12px;
      --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      --box-shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.12);
      --transition: all 0.2s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: var(--font-main);
      background: var(--bg-light); 
      color: var(--ink-light);
      min-height: 100vh; 
      padding: 16px; 
      transition: var(--transition);
      line-height: 1.5;
      font-size: 14px;
    }
    body.active { background: var(--bg-dark); color: var(--ink-dark); }

    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
    }
    
    header { 
      display: flex; 
      gap: 16px; 
      align-items: center; 
      justify-content: space-between; 
      flex-wrap: wrap; 
      margin-bottom: 20px; 
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    body.active header {
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .header-content {
      flex: 1;
      min-width: 240px;
    }
    
    h1 { 
      margin: 0; 
      font-size: 1.6rem; 
      line-height: 1.2;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: -0.3px;
      margin-bottom: 4px;
    }
    body.active h1 {
      color: var(--accent-2);
    }
    
    .subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
      font-weight: 400;
      max-width: 600px;
    }
    body.active .subtitle {
      opacity: 0.7;
    }

    /* Toggle de tema compacto */
    .dark-mode {
      width: 52px; 
      height: 26px; 
      background: linear-gradient(145deg, #e0e0e0, #f5f5f5);
      border-radius: 999px; 
      display: flex; 
      align-items: center;
      cursor: pointer; 
      position: relative; 
      box-shadow: var(--box-shadow);
      user-select: none;
      transition: var(--transition);
    }
    body.active .dark-mode { 
      background: linear-gradient(145deg, #2c2c4e, #24243a); 
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
    }
    .dark-mode .circle {
      position: absolute; 
      top: 2px; 
      left: 2px; 
      width: 22px; 
      height: 22px; 
      border-radius: 50%;
      display: grid; 
      place-items: center; 
      overflow: hidden; 
      background: linear-gradient(145deg, #ffffff, #f0f0f0);
      transition: transform .3s ease, background-color .3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }
    body.active .dark-mode .circle { 
      transform: translateX(26px); 
      background: linear-gradient(145deg, #3a3a5e, #2d2d4d);
    }
    .dark-mode .circle ion-icon { 
      position: absolute; 
      width: 14px; 
      height: 14px; 
      transition: transform .3s ease; 
    }
    .dark-mode .sun { color: #f9c74f; }
    .dark-mode .moon { color: #f8f9fa; transform: translateY(-120%); }
    body.active .dark-mode .sun { transform: translateY(120%); }
    body.active .dark-mode .moon { transform: translateY(0); }

    /* Stats + progreso compactos */
    .progress-container { 
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 0 0 20px;
      background: rgba(255,255,255,0.8);
      padding: 16px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
    }
    body.active .progress-container {
      background: rgba(30, 41, 59, 0.6);
    }
    
    .stats { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }
    .stat-item { 
      text-align:center; 
      padding: 14px; 
      border-radius: var(--border-radius); 
      background: rgba(255,255,255,0.9);
      font-weight: 600;
      font-family: var(--font-secondary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      transition: var(--transition);
      display: flex;
      flex-direction: column;
    }
    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--accent);
    }
    body.active .stat-value {
      color: var(--accent-2);
    }
    .stat-label {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    body.active .stat-item { 
      background: rgba(30, 41, 59, 0.7); 
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .progress { 
      width:100%; 
      height:20px; 
      border-radius:10px; 
      overflow:hidden; 
      position:relative; 
      background:#e0e7ff; 
      box-shadow: inset 0 0 3px rgba(0,0,0,.1); 
    }
    body.active .progress {
      background: #1e293b;
    }
    .progress-bar { 
      height:100%; 
      width:0%; 
      background: linear-gradient(90deg, var(--accent), var(--accent-2)); 
      transition: width .4s ease; 
      position: relative; 
    }
    .progress-text { 
      position:absolute; 
      inset:0; 
      display:grid; 
      place-items:center; 
      font-size:11px; 
      font-weight:700; 
      color:#fff; 
      text-shadow: 0 1px 1px rgba(0,0,0,.4); 
      pointer-events:none; 
      letter-spacing: 0.3px;
    }

    /* Leyenda compacta */
    .legend { 
      display:flex; 
      gap:10px 16px; 
      flex-wrap:wrap; 
      justify-content:center; 
      font-size:12px; 
      margin-bottom: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.8);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
      font-family: var(--font-secondary);
    }
    body.active .legend {
      background: rgba(30, 41, 59, 0.6);
    }
    
    .legend .cuadro { 
      width:12px; 
      height:12px; 
      border-radius:3px; 
      display:inline-block; 
      vertical-align:middle; 
      margin-right:6px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .lg-aprob { background:#d1fae5; } 
    .lg-disp { background:#fef3c7; } 
    .lg-bloq { background:#e2e8f0; }

    /* Controles compactos */
    .controls-container {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .controls { 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
      justify-content: flex-start;
    }
    .btn { 
      display:inline-flex; 
      align-items:center; 
      gap:6px; 
      padding:8px 14px; 
      border:none; 
      border-radius:10px; 
      cursor:pointer; 
      background: var(--accent); 
      color:#fff; 
      font-weight:600; 
      font-size: 13px;
      font-family: var(--font-secondary);
      transition: var(--transition); 
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
    }
    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: var(--box-shadow-hover); 
      background: var(--accent-dark);
    }
    .btn:active { 
      transform: translateY(0); 
    }
    .btn.active { 
      background: var(--accent-2); 
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    .btn.active:hover {
      background: #0da271;
    }
    /* Efecto ripple */
    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }
    .btn:active::after {
      width: 100px;
      height: 100px;
    }

    .search-container { 
      display:flex; 
      align-items:center; 
      gap:10px; 
      background: var(--card-light); 
      border-radius: var(--border-radius); 
      padding: 10px 14px; 
      box-shadow: var(--box-shadow); 
      transition: var(--transition);
      max-width: 320px;
    }
    body.active .search-container { 
      background: var(--card-dark); 
      box-shadow: 0 2px 8px rgba(0,0,0,.25); 
    }
    .search-container ion-icon { 
      opacity:.7; 
      font-size: 16px;
    }
    #search-input { 
      flex:1; 
      border:none; 
      outline:none; 
      background: transparent; 
      font-size: 13px; 
      color: inherit; 
      font-family: var(--font-secondary);
    }
    #search-input::placeholder {
      color: #888;
      font-size: 13px;
    }
    body.active #search-input::placeholder {
      color: #aaa;
    }

    .area-filter { 
      display:flex; 
      flex-wrap:wrap; 
      gap:6px; 
      margin-bottom: 16px; 
      padding: 12px;
      background: rgba(255,255,255,0.8);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
    }
    body.active .area-filter {
      background: rgba(30, 41, 59, 0.6);
    }
    
    .area-btn { 
      padding: 6px 12px; 
      border-radius: 50px; 
      border: none; 
      font-size: 12px; 
      cursor:pointer; 
      opacity: .85; 
      transition: var(--transition); 
      color:#fff; 
      font-weight: 500;
      font-family: var(--font-secondary);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .area-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      opacity: 0.95;
    }
    .area-btn.active { 
      opacity: 1; 
      transform: scale(1.04); 
      box-shadow: 0 3px 8px rgba(0,0,0,.2);
      font-weight: 600;
    }
    .area-btn[data-area="all"] { 
      background: #64748b; 
    }
    .area-btn[data-area="programacion"] { background: var(--programacion); }
    .area-btn[data-area="matematicas"] { background: var(--matematicas); }
    .area-btn[data-area="fisica"] { background: var(--fisica); }
    .area-btn[data-area="ingenieria"] { background: var(--ingenieria); color:#222; }
    .area-btn[data-area="humanidades"] { background: var(--humanidades); color:#222; }
    .area-btn[data-area="optativos"] { background: var(--optativos); }
    .area-btn[data-area="fofus"] { background: var(--fofu); color:#111; }

    /* Grid compacto */
    .grid { 
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 18px;
    }
    .semestre { 
      background: var(--card-light); 
      color:inherit; 
      padding: 18px 16px; 
      border-radius:var(--border-radius); 
      box-shadow: var(--box-shadow); 
      transition: var(--transition); 
      display: flex;
      flex-direction: column;
    }
    body.active .semestre { 
      background: var(--card-dark); 
      box-shadow: 0 6px 15px rgba(0,0,0,.2); 
    }
    .semestre h3 { 
      margin: 0 0 16px 0; 
      font-size: 1.1rem; 
      opacity:.9;
      font-weight: 600;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      color: var(--accent);
      text-align: center;
      position: relative;
    }
    .semestre h3::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
    }
    body.active .semestre h3 {
      color: var(--accent-2);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    body.active .semestre h3::after {
      background: var(--accent-2);
    }

    .ramo { 
      margin: 8px 0; 
      padding: 12px; 
      border-radius:10px; 
      cursor:pointer; 
      text-align:center; 
      font-size:13px; 
      position:relative; 
      display:flex; 
      flex-direction:column; 
      justify-content:center; 
      min-height:64px; 
      transition: var(--transition); 
      outline: none; 
      background: #f8fafc;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
      border-left: 4px solid var(--programacion);
    }
    body.active .ramo {
      background: #1e293b;
    }
    .ramo:hover { 
      transform: translateY(-2px); 
      box-shadow: var(--box-shadow-hover); 
    }
    .ramo:focus-visible { 
      outline: 2px solid var(--accent); 
      outline-offset: 2px; 
    }

    .ramo[data-area="programacion"] { border-left-color: var(--programacion); }
    .ramo[data-area="matematicas"] { border-left-color: var(--matematicas); }
    .ramo[data-area="fisica"] { border-left-color: var(--fisica); }
    .ramo[data-area="ingenieria"] { border-left-color: var(--ingenieria); }
    .ramo[data-area="humanidades"] { border-left-color: var(--humanidades); }
    .ramo[data-area="optativos"] { border-left-color: var(--optativos); }
    .ramo[data-area="fofus"] { border-left-color: var(--fofu); }

    .ramo .ramo-nombre { 
      font-weight:600; 
      margin-bottom:4px; 
      font-size: 14px;
    }
    .ramo .ramo-detalles { 
      display:flex; 
      justify-content:space-between; 
      font-size:12px; 
      gap:6px; 
      opacity: 0.85;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed rgba(0,0,0,0.1);
    }
    body.active .ramo .ramo-detalles {
      border-top: 1px dashed rgba(255,255,255,0.1);
    }
    .ramo .ramo-sigla { 
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    .ramo .ramo-creditos { 
      font-weight:600; 
    }

    .bloqueado { 
      background:#e9ecef !important; 
      color:#6c757d !important; 
      cursor:not-allowed; 
      opacity: 0.8;
    }
    body.active .bloqueado {
      background: #1e293b !important;
      color: #94a3b8 !important;
    }
    .disponible { 
      background:#fef3c7 !important; 
      color:#000 !important; 
    }
    body.active .disponible {
      background: #1e293b !important;
    }
    .aprobado { 
      background:#d1fae5 !important; 
      color:#000 !important; 
    }
    body.active .aprobado {
      background: #0f1d15 !important;
    }

    .desbloqueado { 
      animation: fadeInScale .3s ease forwards; 
      opacity: 0; 
      transform: scale(.97); 
    }
    @keyframes fadeInScale { 
      to { 
        opacity:1; 
        transform: scale(1);
      }
    }

    .retirado { 
      animation: fadeOutScale .3s ease forwards; 
      opacity:1; 
      transform:scale(1); 
    }
    @keyframes fadeOutScale { 
      to { 
        opacity:0; 
        transform:scale(.95);
      }
    }

    /* Tooltip mejorado */
    .ramo:hover::after, .ramo:focus-visible::after {
      content: attr(data-tooltip);
      position: absolute; 
      bottom: 110%; 
      left: 50%; 
      transform: translateX(-50%);
      background: #1e293b; 
      color:#f8fafc; 
      padding: 12px 16px; 
      border-radius: 8px; 
      font-size: 12px; 
      white-space: pre-wrap; 
      opacity:.98; 
      pointer-events:none; 
      z-index:9999;
      width: min(var(--box-w, 280px), var(--tip-max-w, 380px), calc(100vw - 24px)); 
      box-sizing: border-box; 
      text-align:center; 
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
      line-height: 1.4;
      font-family: var(--font-secondary);
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Tooltip touch */
    #touch-tip { 
      position: fixed; 
      background: #1e293b; 
      color: #f8fafc; 
      font-size: 12px; 
      line-height: 1.4; 
      padding: 10px 14px; 
      border-radius: 8px; 
      box-shadow: 0 8px 20px rgba(0,0,0,.35); 
      z-index: 10000; 
      max-width: none; 
      display: none; 
      white-space: pre-wrap; 
      transform: translate(-50%, -8px); 
      pointer-events: none; 
      box-sizing: border-box; 
      text-align: center; 
      font-family: var(--font-secondary);
    }

    .ramo{
      -webkit-tap-highlight-color: transparent; 
      -webkit-touch-callout: none; 
      user-select: none; 
      touch-action: manipulation;
    }

    /* Accesibilidad oculta */
    .sr-only { position:absolute !important; width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0,0,0,0) !important; white-space:nowrap !important; border:0 !important; }

    /* Resaltado SOLO de prerrequisitos */
    .is-self { box-shadow: 0 0 0 2px rgba(0,0,0,.15) inset; }
    .is-prereq { 
      outline: 2px dashed #3b82f6; 
      outline-offset: 2px; 
      z-index: 10;
    }

    /* ========= TOASTS Y CONFETI ========= */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-light);
      color: var(--ink-light);
      padding: 12px 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideInUp 0.3s ease;
    }
    body.active .toast {
      background: var(--card-dark);
      color: var(--ink-dark);
    }
    @keyframes slideInUp {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    .toast.success {
      border-left: 4px solid var(--accent-2);
    }
    .toast.info {
      border-left: 4px solid var(--accent);
    }
    
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--accent);
      opacity: 0;
      z-index: 9999;
      pointer-events: none;
    }

    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
      .controls-container {
        grid-template-columns: 1fr;
      }
      .search-container {
        max-width: 100%;
      }
      header { flex-direction:column; text-align:center; gap: 16px; }
      .controls { flex-direction:column; }
      .btn { width:100%; max-width: 100%; justify-content:center; }
      .progress-container, .legend, .area-filter {
        padding: 14px;
      }
      .stats {
        grid-template-columns: 1fr 1fr;
      }
    }

    .footer { 
      text-align:center; 
      padding: 20px 0; 
      margin-top: 30px; 
      font-size:13px; 
      color:#666; 
      border-top: 1px solid #e2e8f0; 
      transition: color .3s, border-color .3s; 
      font-family: var(--font-secondary);
    }
    body.active .footer { 
      color:#aaa; 
      border-top-color:#334155; 
    }
    .footer a { 
      color: var(--accent); 
      text-decoration: none; 
      font-weight: 500;
      transition: color 0.2s;
    }
    body.active .footer a { 
      color: #818cf8; 
    }
    .footer a:hover { 
      text-decoration: underline; 
      color: var(--accent-dark);
    }
    
    /* Mensaje sin resultados */
    .no-results {
      text-align: center;
      padding: 30px 16px;
      font-size: 16px;
      color: #64748b;
      grid-column: 1 / -1;
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255,255,255,0.8);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      backdrop-filter: blur(4px);
    }
    body.active .no-results {
      background: rgba(30, 41, 59, 0.6);
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <h1>Malla Interactiva — Ingeniería Civil en Informática</h1>
        <div class="subtitle">Seguimiento de progreso en Ingeniería Civil en Informática</div>
      </div>
      <div class="dark-mode" id="theme-toggle" aria-label="Cambiar tema" role="switch" aria-checked="false" tabindex="0">
        <div class="circle">
          <ion-icon class="sun" name="sunny"></ion-icon>
          <ion-icon class="moon" name="moon"></ion-icon>
        </div>
      </div>
    </header>

    <div class="progress-container" aria-live="polite">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="total-ramos">0</div>
          <div class="stat-label">Total ramos</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="aprobados-ramos">0</div>
          <div class="stat-label">Aprobados</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="creditos-total">0/0</div>
          <div class="stat-label">Créditos</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="porcentaje">0%</div>
          <div class="stat-label">Progreso</div>
        </div>
      </div>
      <div class="progress" aria-label="Progreso total">
        <div class="progress-bar" id="barraProgreso">
          <div class="progress-text" id="textoProgreso">0%</div>
        </div>
      </div>
    </div>

    <div class="legend">
      <span><span class="cuadro lg-aprob"></span> Aprobado</span>
      <span><span class="cuadro lg-disp"></span> Disponible</span>
      <span><span class="cuadro lg-bloq"></span> Bloqueado</span>
    </div>

    <div class="area-filter" role="group" aria-label="Filtrar por área">
      <button class="area-btn" data-area="all">Todos</button>
      <button class="area-btn" data-area="programacion">Programación</button>
      <button class="area-btn" data-area="matematicas">Matemáticas</button>
      <button class="area-btn" data-area="fisica">Física</button>
      <button class="area-btn" data-area="ingenieria">Ingeniería</button>
      <button class="area-btn" data-area="humanidades">Humanidades</button>
      <button class="area-btn" data-area="fofus">Fofus</button>
      <button class="area-btn" data-area="optativos">Optativos</button>
    </div>

    <div class="controls-container">
      <div class="controls">
        <button class="btn" id="btn-reset"><ion-icon name="refresh-outline"></ion-icon> Reiniciar</button>
        <button class="btn" id="toggle-disponibles"><ion-icon name="eye-outline"></ion-icon> Disponibles</button>
      </div>
      <div class="search-container">
        <ion-icon name="search-outline"></ion-icon>
        <input type="text" id="search-input" placeholder="Buscar por nombre o sigla…" aria-label="Buscar ramos">
      </div>
    </div>

    <div class="grid" id="malla" role="list"></div>
  </div>

  <div class="footer">
    Desarrollado por <a href="https://www.instagram.com/chelo_.morales" target="_blank" rel="noopener">Marcelo Morales</a>
  </div>

  <!-- Tooltip touch -->
  <div id="touch-tip" role="status" aria-live="polite"></div>

  <!-- Toasts -->
  <div id="toast-container"></div>

<script>
// ========= Utilidades =========
const normalizarTexto = (str) => (str || '').normalize('NFD').replace(/[̀-ͯ]/g, '').toLowerCase();
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const cssVarPx = (name, fallback) => { const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim(); const n = parseFloat(v); return Number.isFinite(n) ? n : fallback; };

// ========= Config tooltip touch =========
const CONFIG = { tipMinW: 140, tipMaxW: null, tapMs: 140, moveHoverThrottleMs: 400, tipLongPress: false };

// ========= Modo Oscuro =========
const toggle = document.getElementById('theme-toggle');
const body = document.body;
const applyTheme = (mode) => { if (mode === 'dark') body.classList.add('active'); else body.classList.remove('active'); toggle?.setAttribute('aria-checked', mode === 'dark' ? 'true' : 'false'); };
applyTheme(localStorage.getItem('modo') || 'light');
const swapTheme = () => { const isDark = body.classList.toggle('active'); const modo = isDark ? 'dark' : 'light'; localStorage.setItem('modo', modo); toggle?.setAttribute('aria-checked', isDark ? 'true' : 'false'); };

toggle?.addEventListener('click', swapTheme);
toggle?.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); swapTheme(); } });

// ========= Sistema de Toasts =========
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <ion-icon name="${type === 'success' ? 'checkmark-circle' : 'information-circle'}"></ion-icon>
    <span>${message}</span>
  `;
  
  document.getElementById('toast-container').appendChild(toast);
  
  // Remover después de 3 segundos
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(-20px)';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 3000);
}

// ========= Efecto Confetti =========
function createConfetti() {
  const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
  
  for (let i = 0; i < 30; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + 'vw';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.opacity = '1';
    document.body.appendChild(confetti);
    
    // Animación
    const animation = confetti.animate([
      { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
      { transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }
    ], {
      duration: 1000 + Math.random() * 1000,
      easing: 'cubic-bezier(0.1, 0.8, 0.2, 1)'
    });
    
    animation.onfinish = () => {
      if (confetti.parentNode) {
        confetti.parentNode.removeChild(confetti);
      }
    };
  }
}

// ========= Datos: Malla actualizada según archivo de texto =========
const cursosRaw = [
  // Semestre 1
  {sem:1, sigla:"MAT1001", nombre:"Fundamentos de Matemáticas para Ingeniería", creditos:6, area:"matematicas", prereqs:[]},
  {sem:1, sigla:"ICI1243", nombre:"Introducción a la Ingeniería Informática", creditos:4, area:"ingenieria", prereqs:[]},
  {sem:1, sigla:"ICI1241", nombre:"Fundamentos de Algoritmos", creditos:4, area:"programacion", prereqs:[]},
  {sem:1, sigla:"ICI1458", nombre:"Bienestar y Aprendizaje Universitario", creditos:2, area:"humanidades", prereqs:[]},
  
  // Semestre 2
  {sem:2, sigla:"MAT1002", nombre:"Cálculo Diferencial e Integral", creditos:6, area:"matematicas", prereqs:["MAT1001"]},
  {sem:2, sigla:"MAT1004", nombre:"Álgebra Lineal", creditos:4, area:"matematicas", prereqs:["MAT1001"]},
  {sem:2, sigla:"ICI1242", nombre:"Fundamentos de Programación", creditos:4, area:"programacion", prereqs:["ICI1241"]},
  {sem:2, sigla:"FIN100-14", nombre:"Desarrollo Integral y Comunicación para Ingeniería", creditos:3, area:"humanidades", prereqs:[]},
  {sem:2, sigla:"FF1", nombre:"Formación Fundamental", creditos:2, area:"fofus", prereqs:[]},
  
  // Semestre 3
  {sem:3, sigla:"FIS1002", nombre:"Física para Ingeniería", creditos:5, area:"fisica", prereqs:["MAT1001"]},
  {sem:3, sigla:"MAT1003", nombre:"Cálculo en Varias Variables", creditos:4, area:"matematicas", prereqs:["MAT1002"]},
  {sem:3, sigla:"ICI2145", nombre:"Análisis Inteligente de Datos", creditos:4, area:"programacion", prereqs:["MAT1002"]},
  {sem:3, sigla:"ICI2240", nombre:"Estructura de Datos", creditos:4, area:"programacion", prereqs:["ICI1242"]},
  {sem:3, sigla:"ICR010", nombre:"Antropología Cristiana", creditos:2, area:"fofus", prereqs:[]},
  {sem:3, sigla:"FF2", nombre:"Formación Fundamental 2", creditos:2, area:"fofus", prereqs:[]},
  
  // Semestre 4
  {sem:4, sigla:"FIS2120", nombre:"Física Electromagnetismo", creditos:3, area:"fisica", prereqs:["FIS1002"]},
  {sem:4, sigla:"ICI2141", nombre:"Métodos Numéricos", creditos:3, area:"matematicas", prereqs:["ICI1242"]},
  {sem:4, sigla:"ICI2242", nombre:"Análisis y Diseño de Algoritmos", creditos:4, area:"programacion", prereqs:[]},
  {sem:4, sigla:"ICI2241", nombre:"Programación Avanzada", creditos:4, area:"programacion", prereqs:["ICI2240"]},
  {sem:4, sigla:"ICR020", nombre:"Ética Cristiana", creditos:2, area:"fofus", prereqs:[]},
  {sem:4, sigla:"ING9001", nombre:"Inglés 1", creditos:2, area:"humanidades", prereqs:[]},
  
  // Semestre 5
  {sem:5, sigla:"FIS3149", nombre:"Física Moderna", creditos:3, area:"fisica", prereqs:["FIS2120"]},
  {sem:5, sigla:"ICI3245", nombre:"Autómatas y Compiladores", creditos:3, area:"programacion", prereqs:["ICI2241"]},
  {sem:5, sigla:"ICI3240", nombre:"Base de Datos", creditos:4, area:"programacion", prereqs:["ICI1242"]},
  {sem:5, sigla:"ICI3244", nombre:"Inteligencia Artificial", creditos:4, area:"programacion", prereqs:["ICI2242"]},
  {sem:5, sigla:"ICI3344", nombre:"Hardware y Sistemas Operativos", creditos:4, area:"ingenieria", prereqs:["ICI1242"]},
  {sem:5, sigla:"ING9002", nombre:"Inglés 2", creditos:2, area:"humanidades", prereqs:["ING9001"]},
  
  // Semestre 6
  {sem:6, sigla:"ICI3150", nombre:"Ciencia y Tecnología", creditos:3, area:"ingenieria", prereqs:[]},
  {sem:6, sigla:"ICI3170", nombre:"Estadística Computacional", creditos:4, area:"matematicas", prereqs:["MAT1003"]},
  {sem:6, sigla:"ICA4121", nombre:"Administración de Empresas", creditos:3, area:"ingenieria", prereqs:[]},
  {sem:6, sigla:"ICI3246", nombre:"Modelamiento de Software", creditos:4, area:"programacion", prereqs:["ICI3240"]},
  {sem:6, sigla:"ICI3343", nombre:"Redes de Computadores", creditos:4, area:"ingenieria", prereqs:["ICI3245"]},
  {sem:6, sigla:"ING9003", nombre:"Inglés 3", creditos:2, area:"humanidades", prereqs:["ING9002"]},
  
  // Semestre 7
  {sem:7, sigla:"ICI4150", nombre:"Robótica y Sistemas Autónomos", creditos:3, area:"ingenieria", prereqs:["ICI3343"]},
  {sem:7, sigla:"ICI4151", nombre:"Optimización", creditos:4, area:"matematicas", prereqs:[]},
  {sem:7, sigla:"ICI4244", nombre:"Ingeniería de Software", creditos:4, area:"ingenieria", prereqs:["ICI3246"]},
  {sem:7, sigla:"ICI4247", nombre:"Ingeniería Web y Móvil", creditos:4, area:"programacion", prereqs:["ICI3246"]},
  {sem:7, sigla:"ICI4344", nombre:"Computación Paralela y Distribuida", creditos:4, area:"ingenieria", prereqs:["ICI3343"]},
  {sem:7, sigla:"ING9004", nombre:"Inglés 4", creditos:2, area:"humanidades", prereqs:["ING9003"]},
  
  // Semestre 8
  {sem:8, sigla:"ICA4161", nombre:"Economía y Finanzas", creditos:3, area:"ingenieria", prereqs:["ICA4121"]},
  {sem:8, sigla:"ICI4248", nombre:"Ingeniería de Requerimientos", creditos:4, area:"programacion", prereqs:["ICI4247"]},
  {sem:8, sigla:"ICI4541", nombre:"Taller de Base de Datos", creditos:4, area:"programacion", prereqs:["ICI3240"]},
  {sem:8, sigla:"ICI4370", nombre:"Ciberseguridad", creditos:4, area:"ingenieria", prereqs:["ICI3343"]},
  {sem:8, sigla:"FF3", nombre:"Formación Fundamental 3", creditos:2, area:"fofus", prereqs:[]},
  {sem:8, sigla:"OPT1", nombre:"Optativo I", creditos:4, area:"optativos", prereqs:[]},
  
  // Semestre 9
  {sem:9, sigla:"ICI5441", nombre:"Administración de proyectos informáticos", creditos:3, area:"ingenieria", prereqs:[]},
  {sem:9, sigla:"ICI5545", nombre:"Taller Ingeniería de Software", creditos:4, area:"ingenieria", prereqs:["ICI4244"]},
  {sem:9, sigla:"ICI5442", nombre:"Tecnologías Emergentes", creditos:4, area:"ingenieria", prereqs:[]},
  {sem:9, sigla:"ICI5247", nombre:"Experiencia del Usuario", creditos:3, area:"ingenieria", prereqs:["ICI4248"]},
  {sem:9, sigla:"ICI5475", nombre:"Negocios, innovación y emprendimiento", creditos:3, area:"ingenieria", prereqs:[]},
  {sem:9, sigla:"OPT2", nombre:"Optativo II", creditos:4, area:"optativos", prereqs:[]},
  
  // Semestre 10
  {sem:10, sigla:"ICI5444", nombre:"Taller de Formulación de Proyectos Informáticos", creditos:4, area:"ingenieria", prereqs:["ICI5441"]},
  {sem:10, sigla:"ICI5541", nombre:"Seminario de Título", creditos:5, area:"ingenieria", prereqs:["ICA4161", "ICI4248", "ICI4541", "ICI4370", "ICI5441", "ICI5545", "ICI5442", "ICI5247", "ICI5475", "ICI4151", "ICI3170", "ICI3344", "ICI3244"]},
  {sem:10, sigla:"ICI5345", nombre:"Legislación, Ética y Tecnológica", creditos:3, area:"ingenieria", prereqs:[]},
  {sem:10, sigla:"ICI5476", nombre:"Taller de Liderazgo y Trabajo en Equipo", creditos:3, area:"ingenieria", prereqs:[]},
  {sem:10, sigla:"OPT3", nombre:"Optativo III", creditos:4, area:"optativos", prereqs:[]},
  
  // Semestre 11
  {sem:11, sigla:"ICI6541", nombre:"Proyecto de Título", creditos:12, area:"ingenieria", prereqs:["ICI5541"]},
  {sem:11, sigla:"OPT4", nombre:"Optativo IV", creditos:4, area:"optativos", prereqs:[]}
];

// ========= Índices y estructuras =========
const siglaToNombre = new Map(cursosRaw.map(c => [c.sigla, c.nombre]));
const ramos = {};              // nombre -> {semestre, area, sigla, abre:[]}
const creditosRamos = {};      // nombre -> créditos
const prereqsPorNombre = {};   // nombre -> [nombres prereq]

for (const c of cursosRaw) {
  ramos[c.nombre] = { semestre: c.sem, area: c.area, sigla: c.sigla, abre: [] };
  creditosRamos[c.nombre] = c.creditos ?? 0;
  prereqsPorNombre[c.nombre] = (c.prereqs || []).map(sig => siglaToNombre.get(sig)).filter(Boolean);
}
for (const [nombre, lista] of Object.entries(prereqsPorNombre)) {
  for (const p of lista) if (ramos[p]) ramos[p].abre.push(nombre);
}

const porSemestre = {};
for (const [nombre, info] of Object.entries(ramos)) {
  if (!porSemestre[info.semestre]) porSemestre[info.semestre] = [];
  porSemestre[info.semestre].push(nombre);
}
const maxSemestre = Math.max(...Object.values(ramos).map(r => r.semestre));

// ========= Persistencia por SIGLA + Firma malla =========
const firmaMalla = JSON.stringify(cursosRaw.map(c => c.sigla).sort());
const firmaGuardada = localStorage.getItem('firma_malla');
if (firmaGuardada && firmaGuardada !== firmaMalla) {
  localStorage.removeItem('ramos_aprobados_siglas');
}
localStorage.setItem('firma_malla', firmaMalla);

let aprobadasSiglas = JSON.parse(localStorage.getItem('ramos_aprobados_siglas') || '[]');
const setSiglasValidas = new Set(cursosRaw.map(c => c.sigla));
aprobadasSiglas = aprobadasSiglas.filter(s => setSiglasValidas.has(s));
localStorage.setItem('ramos_aprobados_siglas', JSON.stringify(aprobadasSiglas));

const aprobadosNombres = () => aprobadasSiglas.map(s => siglaToNombre.get(s)).filter(Boolean);
const aprobadoPorNombre = new Set(aprobadosNombres());

// ========= Lógica =========
const malla = document.getElementById('malla');
const nombreToEl = new Map();
const estadoAnterior = new Map();
let areaSeleccionada = 'all';
let busqueda = '';
let mostrarSoloDisponibles = false;

const calcularCreditos = () => {
  let total = 0, completados = 0;
  for (const [nombre] of Object.entries(ramos)) {
    const c = creditosRamos[nombre] ?? 0; total += c; if (aprobadoPorNombre.has(nombre)) completados += c;
  }
  const porcentaje = total > 0 ? Math.round((completados / total) * 100) : 0;
  return { total, completados, porcentaje };
};

const prerequisitosDe = (nombre) => [...(prereqsPorNombre[nombre] || [])];
const obtenerTodosDependientes = (nombre) => { const out = new Set(); const dfs = (n) => { for (const d of (ramos[n]?.abre || [])) if (!out.has(d)) { out.add(d); dfs(d); } }; dfs(nombre); return [...out]; };
const estaDisponible = (nombre) => prerequisitosDe(nombre).every(p => aprobadoPorNombre.has(p));

const aprobar = (ramoNombre) => {
  const sigla = ramos[ramoNombre]?.sigla; if (!sigla) return;
  if (aprobadoPorNombre.has(ramoNombre)) {
    const dep = obtenerTodosDependientes(ramoNombre);
    const aEliminar = [ramoNombre, ...dep];
    $$('.ramo').forEach(el => { const n = el.querySelector('.ramo-nombre')?.textContent; if (n && aEliminar.includes(n)) el.classList.add('retirado'); });
    const depSiglas = aEliminar.map(n => ramos[n]?.sigla).filter(Boolean);
    aprobadasSiglas = aprobadasSiglas.filter(s => !depSiglas.includes(s));
    localStorage.setItem('ramos_aprobados_siglas', JSON.stringify(aprobadasSiglas));
    aprobadoPorNombre.clear(); aprobadosNombres().forEach(n => aprobadoPorNombre.add(n));
    render();
    showToast(`Has desaprobado ${ramoNombre} y sus dependencias`, 'info');
  } else {
    if (estaDisponible(ramoNombre)) {
      if (!aprobadasSiglas.includes(sigla)) aprobadasSiglas.push(sigla);
      localStorage.setItem('ramos_aprobados_siglas', JSON.stringify(aprobadasSiglas));
      aprobadoPorNombre.add(ramoNombre);
      render();
      showToast(`¡Felicidades! Has aprobado ${ramoNombre}`, 'success');
      
      // Efecto confetti solo para aprobaciones (no desaprobaciones)
      createConfetti();
    } else {
      showToast('No puedes aprobar este ramo hasta completar sus prerrequisitos', 'info');
    }
  }
};

const resetear = () => { if (confirm('¿Estás seguro de reiniciar todo el progreso?')) { localStorage.removeItem('ramos_aprobados_siglas'); aprobadasSiglas = []; aprobadoPorNombre.clear(); render(); showToast('Progreso reiniciado correctamente', 'info'); } };

// ======== Render ========
const syncBoxWidths = () => { $$('.ramo').forEach(el => { const w = Math.round(el.getBoundingClientRect().width); el.style.setProperty('--box-w', w + 'px'); }); };

const highlightPrereqs = (nombre, on) => { const selfEl = nombreToEl.get(nombre); if (selfEl) selfEl.classList.toggle('is-self', on); for (const p of (prereqsPorNombre[nombre] || [])) { nombreToEl.get(p)?.classList.toggle('is-prereq', on); } };

const render = () => {
  const totalRamos = Object.keys(ramos).length;
  const aprobadosList = aprobadosNombres();
  const { total: creditosTotal, completados: creditosAprobados, porcentaje } = calcularCreditos();

  // Actualizar estadísticas con formato de malla normal
  $('#total-ramos').textContent = totalRamos;
  $('#aprobados-ramos').textContent = aprobadosList.length;
  $('#creditos-total').textContent = `${creditosAprobados}/${creditosTotal}`;
  $('#porcentaje').textContent = `${porcentaje}%`;
  $('#barraProgreso').style.width = porcentaje + '%';
  $('#textoProgreso').textContent = porcentaje + '%';

  const frag = document.createDocumentFragment();
  let semestresRenderizados = 0; const nuevoEstado = new Map(); nombreToEl.clear();

  for (let sem = 1; sem <= maxSemestre; sem++) {
    const ramosSem = (porSemestre[sem] || []).filter(ramo => {
      if (areaSeleccionada !== 'all' && areaSeleccionada !== 'none') {
        if (ramos[ramo].area !== areaSeleccionada) return false;
      }
      if (busqueda) {
        const b = normalizarTexto(busqueda); const n = normalizarTexto(ramo); const s = normalizarTexto(ramos[ramo].sigla || '');
        if (!n.includes(b) && !s.includes(b)) return false;
      }
      if (mostrarSoloDisponibles) {
        if (!aprobadoPorNombre.has(ramo) && !estaDisponible(ramo)) return false;
      }
      return true;
    });

    if (!ramosSem.length) continue;

    const cont = document.createElement('div'); cont.className = 'semestre';
    const title = document.createElement('h3'); title.textContent = `${sem}° Semestre`; cont.appendChild(title);

    const innerFrag = document.createDocumentFragment();

    ramosSem.forEach(ramo => {
      const info = ramos[ramo];
      const div = document.createElement('div');
      div.className = 'ramo';
      div.dataset.area = info.area; div.dataset.creditos = creditosRamos[ramo] ?? ''; div.setAttribute('role', 'listitem'); div.tabIndex = 0;

      const contenido = document.createElement('div');
      const nombreEl = document.createElement('div'); nombreEl.className = 'ramo-nombre'; nombreEl.textContent = ramo; contenido.appendChild(nombreEl);

      const detalles = document.createElement('div'); detalles.className = 'ramo-detalles';
      const siglaEl = document.createElement('span'); siglaEl.className = 'ramo-sigla'; siglaEl.textContent = info.sigla || 'SIGLA';
      const creditos = creditosRamos[ramo];
      const creditosEl = document.createElement('span'); creditosEl.className = 'ramo-creditos'; creditosEl.textContent = `${creditos} créditos`;
      detalles.appendChild(siglaEl); detalles.appendChild(creditosEl);
      contenido.appendChild(detalles);
      div.appendChild(contenido);

      const prere = prerequisitosDe(ramo);
      const desbloqueado = prere.every(p => aprobadoPorNombre.has(p));
      const estadoKey = `${sem}:${ramo}`; nuevoEstado.set(estadoKey, desbloqueado);

      // Tooltip mejorado con más información (como en v3)
      const tooltipText = `📚 ${ramo}\n📋 ${info.sigla} | ${creditos} créditos\n🏷️ ${info.area.charAt(0).toUpperCase() + info.area.slice(1)}\n\n${aprobadoPorNombre.has(ramo) ? '✅ Aprobado\nToca para desmarcar' : estaDisponible(ramo) ? '🟡 Disponible\nToca para aprobar' : `🔒 Bloqueado\nRequiere: ${prere.filter(p => !aprobadoPorNombre.has(p)).join(', ') || 'Ninguno'}`}`;
      
      div.setAttribute('data-tooltip', tooltipText);

      if (aprobadoPorNombre.has(ramo)) {
        div.classList.add('aprobado');
        div.onclick = () => aprobar(ramo);
        div.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); aprobar(ramo); } };
      } else if (estaDisponible(ramo)) {
        div.classList.add('disponible');
        if (!estadoAnterior.get(estadoKey)) { div.classList.add('desbloqueado'); void div.offsetWidth; }
        div.onclick = () => aprobar(ramo);
        div.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); aprobar(ramo); } };
      } else {
        div.classList.add('bloqueado');
      }

      // Resaltado solo de PRERREQUISITOS
      div.addEventListener('mouseenter', () => highlightPrereqs(ramo, true));
      div.addEventListener('mouseleave', () => highlightPrereqs(ramo, false));
      div.addEventListener('focus', () => highlightPrereqs(ramo, true));
      div.addEventListener('blur', () => highlightPrereqs(ramo, false));
      nombreToEl.set(ramo, div);

      innerFrag.appendChild(div);
    });

    cont.appendChild(innerFrag);
    frag.appendChild(cont);
    semestresRenderizados++;
  }

  malla.innerHTML = '';
  malla.appendChild(frag);

  if (semestresRenderizados === 0) {
    const noResults = document.createElement('div'); 
    noResults.className = 'no-results'; 
    noResults.innerHTML = `<ion-icon name="search-outline" style="font-size: 32px; margin-bottom: 8px;"></ion-icon><br>No se encontraron ramos que coincidan con la búsqueda`;
    malla.appendChild(noResults);
  }

  estadoAnterior.clear(); nuevoEstado.forEach((v,k) => estadoAnterior.set(k, v));

  requestAnimationFrame(syncBoxWidths);
  setupTouchTooltips();
};

// ========= Tooltips touch =========
const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
const tip = document.getElementById('touch-tip');
let pressTimer = null; let pressTarget = null; let startX = 0, startY = 0; const MOVE_TOL = 12; const LONG_MS = 500; let touchStartAt = 0;

function showTipFor(target) {
  const txt = target.getAttribute('data-tooltip'); if (!txt) return;
  const boxW = target.getBoundingClientRect().width;
  const maxFromCss = cssVarPx('--tip-max-w', 420);
  const maxPx = (CONFIG.tipMaxW ?? maxFromCss) || 420;
  const vwClamp = Math.max(0, window.innerWidth - 24);
  let w = Math.min(boxW, maxPx, vwClamp); w = Math.max(CONFIG.tipMinW, w);
  tip.style.width = Math.round(w) + 'px';
  tip.textContent = txt; tip.style.display = 'block';
  positionTip(target);
  clearTimeout(tip._hideT); tip._hideT = setTimeout(hideTip, 2500);
}
function hideTip() { tip.style.display = 'none'; tip.textContent = ''; tip.style.width = 'auto'; }
function positionTip(target) { const rect = target.getBoundingClientRect(); const tipRect = tip.getBoundingClientRect(); let x = rect.left + rect.width/2; let y = rect.top - 8; if (rect.top - tipRect.height - 16 < 0) { y = rect.bottom + tipRect.height/2 + 8; tip.style.transform = 'translate(-50%, -8px)'; } else { tip.style.transform = 'translate(-50%, -8px)'; } tip.style.left = x + 'px'; tip.style.top = y + 'px'; }
function clearPress() { clearTimeout(pressTimer); pressTimer = null; pressTarget = null; }
function onTouchStart(e){ touchStartAt = Date.now(); const t = e.target.closest('.ramo'); if (!t) return; pressTarget = t; const touch = e.changedTouches[0]; startX = touch.clientX; startY = touch.clientY; clearPress(); if (CONFIG.tipLongPress) { pressTimer = setTimeout(() => { showTipFor(t); }, LONG_MS); } }
function onTouchMove(e) { if (!pressTimer) return; const touch = e.changedTouches[0]; if (Math.abs(touch.clientX - startX) > MOVE_TOL || Math.abs(touch.clientY - startY) > MOVE_TOL) { clearPress(); } }
function onTouchEnd(){ clearPress(); }
function onScrollOrOutsideTouch() { hideTip(); }
function setupTouchTooltips() {
  if (!isTouch) return;
  document.removeEventListener('touchstart', onTouchStart, {passive:true});
  document.removeEventListener('touchmove', onTouchMove, {passive:true});
  document.removeEventListener('touchend', onTouchEnd, {passive:true});
  document.removeEventListener('scroll', onScrollOrOutsideTouch, true);
  document.addEventListener('touchstart', onTouchStart, {passive:true});
  document.addEventListener('touchmove', onTouchMove, {passive:true});
  document.addEventListener('touchend', onTouchEnd, {passive:true});
  document.addEventListener('scroll', onScrollOrOutsideTouch, true);
}

// ========= Listeners =========
$$('.area-btn').forEach(btn => { btn.addEventListener('click', () => { if (btn.classList.contains('active') && btn.dataset.area === areaSeleccionada) { btn.classList.remove('active'); areaSeleccionada = 'none'; } else { $$('.area-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); areaSeleccionada = btn.dataset.area; } render(); }); });
let debounceTimer = null; document.getElementById('search-input').addEventListener('input', (e) => { clearTimeout(debounceTimer); const v = e.target.value; debounceTimer = setTimeout(() => { busqueda = v; render(); }, 120); });
$('#toggle-disponibles').addEventListener('click', () => { mostrarSoloDisponibles = !mostrarSoloDisponibles; const boton = $('#toggle-disponibles'); if (mostrarSoloDisponibles) { boton.classList.add('active'); boton.innerHTML = '<ion-icon name="eye-off-outline"></ion-icon> Mostrar Todos'; } else { boton.classList.remove('active'); boton.innerHTML = '<ion-icon name="eye-outline"></ion-icon> Solo Disponibles'; } render(); });
$('#btn-reset').addEventListener('click', resetear);

// Primera pinta
render();

// ========= Navegación con teclado =========
(function(){
  const isVisible = (el) => !!(el.offsetParent);
  const $ramos = () => Array.from(document.querySelectorAll('.ramo')).filter(isVisible);

  const center = (el) => {
    const r = el.getBoundingClientRect();
    return {x: r.left + r.width/2, y: r.top + r.height/2};
  };

  function pickInDirection(from, dir){
    const origin = center(from);
    const candidates = $ramos().filter(el => !el.classList.contains('bloqueado') && el!==from);
    if (!candidates.length) return null;

    const weight = (dx,dy) => {
      if (dir==='ArrowRight' && dx>0) return dx*dx + (dy*dy)*0.7;
      if (dir==='ArrowLeft'  && dx<0) return dx*dx + (dy*dy)*0.7;
      if (dir==='ArrowDown'  && dy>0) return (dy*dy) + (dx*dx)*0.7;
      if (dir==='ArrowUp'    && dy<0) return (dy*dy) + (dx*dx)*0.7;
      return Infinity;
    };

    let best = null, bestScore = Infinity;
    for (const el of candidates){
      const c = center(el);
      const dx = c.x - origin.x, dy = c.y - origin.y;
      const score = weight(dx,dy);
      if (score < bestScore){ bestScore = score; best = el; }
    }
    return isFinite(bestScore) ? best : null;
  }

  document.addEventListener('focusin', (ev) => {
    const el = ev.target;
    if (!(el instanceof HTMLElement)) return;
    if (!el.classList?.contains('ramo')) return;
    if (!el.classList.contains('bloqueado')) return;

    const next = pickInDirection(el, 'ArrowRight')
              || pickInDirection(el, 'ArrowDown')
              || pickInDirection(el, 'ArrowLeft')
              || pickInDirection(el, 'ArrowUp');

    if (next){ 
      setTimeout(() => next.focus(), 0);
    }
  });

  document.addEventListener('keydown', (ev) => {
    const { key } = ev;
    const active = document.activeElement;
    const dentroDeRamo = active?.classList?.contains('ramo');

    if ((key === 'Enter' || key === ' ') && dentroDeRamo){
      ev.preventDefault();
      active.click?.();
      return;
    }

    if (!['ArrowRight','ArrowLeft','ArrowUp','ArrowDown'].includes(key)) return;
    if (!dentroDeRamo){
      const primero = $ramos().find(el => !el.classList.contains('bloqueado'));
      if (primero){ primero.focus(); ev.preventDefault(); }
      return;
    }

    const next = pickInDirection(active, key);
    if (next){
      next.focus();
      ev.preventDefault();
    }
  });
})();
</script>
</body>
</html>
